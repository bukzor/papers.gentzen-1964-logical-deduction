#!/bin/bash
# Run a segment script on its corresponding page image
# Usage: bin/segment image-segments/290-left.sh
#   Reads from images/290.png
#   Writes to image-segments/290-left.png

set -euo pipefail

if [[ $# -ne 1 ]]; then
    echo "Usage: $0 SEGMENT_SCRIPT" >&2
    echo "  Example: $0 image-segments/290-left.sh" >&2
    exit 1
fi

segment_script="$1"

if [[ ! -f "$segment_script" ]]; then
    echo "Error: Segment script not found: $segment_script" >&2
    exit 1
fi

# Extract page number and segment name from script path
# e.g., image-segments/290-left.sh -> page=290, segment=left
basename=$(basename "$segment_script" .sh)
page=$(echo "$basename" | cut -d- -f1)
segment=$(echo "$basename" | cut -d- -f2-)

input_image="images/${page}.png"
output_image="image-segments/${page}-${segment}.png"

if [[ ! -f "$input_image" ]]; then
    echo "Error: Input image not found: $input_image" >&2
    exit 1
fi

mkdir -p image-segments

cat "$input_image" | bash "$segment_script" > "$output_image"

echo "Created: $output_image" >&2
